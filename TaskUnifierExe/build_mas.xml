<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="create-mac-app-store-binary" name="TaskUnifierExeMacAppStore">
	
    <property environment="env"/>
	<property name="directory.api" value="${basedir}/../TaskUnifierApi"/>
	<property name="directory.exe" value="${basedir}/../TaskUnifierExe"/>
	<property name="directory.gui" value="${basedir}/../TaskUnifierGui"/>
	<property name="directory.web" value="${basedir}/../TaskUnifierWebSite"/>
	
	<taskdef resource="net/jtools/classloadertask/antlib.xml" classpath="${directory.exe}/tools/ant-classloadertask/ant-classloadertask.jar"/>
	<taskdef name="izpack" classname="com.izforge.izpack.ant.IzPackTask" classpath="${directory.exe}/tools/izpack/standalone-compiler.jar"/>
	<taskdef name="jarbundler" classname="net.sourceforge.jarbundler.JarBundler" classpath="${directory.exe}/tools/jarbundler/jarbundler-2.2.0.jar"/>
	<taskdef name="jsmoothgen" classname="net.charabia.jsmoothgen.ant.JSmoothGen" classpath="${directory.exe}/tools/jsmooth/jsmoothgen-ant.jar"/>
	<taskdef name="bundleapp" classname="com.oracle.appbundler.AppBundlerTask" classpath="${directory.exe}/tools/appbundler/appbundler-1.0ea.jar"/>
	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${directory.exe}/tools/ant-contrib/ant-contrib-1.0b3.jar"/>
		</classpath>
	</taskdef>
	
	<classloader loader="system" classpath="${directory.exe}/tools/commons-net/commons-net-2.2.jar"/>
	<classloader loader="system" classpath="${directory.exe}/tools/jsch/jsch-0.1.44.jar"/>
	
	<target depends="taskunifier-version-underscored" name="create-mac-app-store-binary">
		<echo message="Creating mac tar file..."/>
		<antcall target="clean"/>
		<mkdir dir="${directory.exe}/temp"/>
		
		<bundleapp 
				outputdirectory="${directory.exe}/temp"
				name="TaskUnifier"
				displayname="TaskUnifier"
				identifier="com.leclercb.taskunifier"
				shortversion="${taskunifier.version}"
				version="${taskunifier.version}"
				icon="${directory.gui}/resources/icon.icns"
				mainclassname="com.leclercb.taskunifier.gui.main.Main"
				copyright="Copyright (c) 2011, Benjamin Leclerc"
				applicationCategory="public.app-category.productivity">

			<runtime dir="${runtime}/Contents/Home"/>

			<arch name="x86_64"/>
			<arch name="i386"/>
			
			<classpath dir="${directory.gui}/dist">
				<include name="taskunifiergui.jar" />
			</classpath>
			
			<classpath dir="${directory.gui}">
				<include name="lib/" />
				<exclude name="lib/applejavaextensions.jar" />
			</classpath>
			
			<librarypath dir="${directory.gui}">
				<include name="notes/" />
				<include name="resources/" />
			</librarypath>

			<bundledocument extensions="tue"
					icon="${directory.gui}/resources/icon.icns"
					name="TaskUnifier Exchange files"
					role="editor"
					isPackage="true">
			</bundledocument>

			<option value="-Xdock:icon=Contents/Resources/icon.icns"/>
			
			<option value="-Dcom.leclercb.taskunifier.resource_folder=$APP_ROOT/Contents/MacOS/resources"/>
			<option value="-Dcom.leclercb.taskunifier.data_folder=true"/>

			<option value="-Dapple.laf.useScreenMenuBar=true"/>
			<option value="-Dcom.apple.macos.useScreenMenuBar=true"/>
			<option value="-Dcom.apple.macos.use-file-dialog-packages=true"/>

			<option value="-Xmx512m"/>
			
		</bundleapp>
		
		<exec executable="${directory.exe}/scripts/mac.codesign.sh" failonerror="true">
			<arg line="-a"/>
		</exec>
		
		<mkdir dir="${directory.exe}/binaries/TaskUnifier_${taskunifier.version.underscored}"/>
		<mkdir dir="${directory.exe}/binaries/TaskUnifier_${taskunifier.version.underscored}/mas"/>
		<tar destfile="${directory.exe}/binaries/TaskUnifier_${taskunifier.version.underscored}/mas/TaskUnifier_${taskunifier.version.underscored}_mac.tar">
			<tarfileset dir="${directory.exe}/temp">
				<include name="**/*"/>	 
				<exclude name="**/JavaApplicationStub"/>
				<TBD>
			</tarfileset>
			<tarfileset dir="${directory.exe}/temp" filemode="755">
				<include name="**/JavaApplicationStub"/>
				<TBD>
			</tarfileset>
		</tar>
		<antcall target="create-mac-pkg"/>
	</target>
	
	<target depends="check-os, taskunifier-version-underscored" name="create-mac-pkg" if="isMac">
		<echo message="Creating mac pkg file..."/>
		<antcall target="clean"/>
		<exec executable="${directory.exe}/scripts/mac.create_pkg.sh" failonerror="true">
			<arg line="${taskunifier.version.underscored}"/>
		</exec>
	</target>
	
	<target name="clean">
		<echo message="Cleaning..."/>
		<delete dir="${directory.exe}/temp"/>
		<delete file="${directory.gui}/resources/taskunifier.properties"/>
	</target>
	
	<target name="check-os">
		<condition property="isMac">
			<os family="mac"/>
		</condition>
	</target>
	
	<target name="taskunifier-version-underscored">
		<propertyregex 
			property="taskunifier.version.underscored" 
			override="false"
			input="${taskunifier.version}" 
			regexp="\."
			replace="_"
			global="true"/>
	</target>
	
</project>